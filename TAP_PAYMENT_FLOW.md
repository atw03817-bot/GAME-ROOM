# ๐ ุณูุฑ ุนูููุฉ Tap Payment - ุงููุธุงู ุงูุฌุฏูุฏ

## โ ุชู ุฅุตูุงุญ ุฌููุน ุงููุดุงูู!

### ุงููุดุงูู ุงูุชู ูุงูุช ููุฌูุฏุฉ:
1. โ ุงูุณูุฉ ุชุฎุชูู ูุจู ุงูุฏูุน
2. โ ุงูุทูุจุงุช ุชุธูุฑ ููุฅุฏุงุฑุฉ ูุจู ุงูุฏูุน
3. โ ุงููุฎุฒูู ููุฎุตู ูุจู ุงูุฏูุน
4. โ ูุง ุชูุฌุฏ ุตูุญุฉ ููุชุนุงูู ูุน ูุดู ุงูุฏูุน

### ุงูุญููู ุงููุทุจูุฉ:
1. โ ุงูุณูุฉ ุชุจูู ุญุชู ูุฌุงุญ ุงูุฏูุน
2. โ ุงูุทูุจุงุช pending ูุง ุชุธูุฑ ููุฅุฏุงุฑุฉ
3. โ ุงููุฎุฒูู ููุฎุตู ููุท ุจุนุฏ ูุฌุงุญ ุงูุฏูุน
4. โ ุตูุญุฉ ุงุญุชุฑุงููุฉ ููุดู ุงูุฏูุน ูุน ุงุณุชุฑุฌุงุน ุงูุณูุฉ

---

## ๐ ุณูุฑ ุงูุนูููุฉ ุงูุฌุฏูุฏ:

### 1๏ธโฃ ุงูุนููู ูู ุตูุญุฉ Checkout
```
- ูุฎุชุงุฑ ุงูููุชุฌุงุช
- ูุฎุชุงุฑ ุงูุนููุงู
- ูุฎุชุงุฑ ุดุฑูุฉ ุงูุดุญู
- ูุฎุชุงุฑ Tap Payment
- ูุถุบุท "ุชุฃููุฏ ุงูุทูุจ"
```

### 2๏ธโฃ ุฅูุดุงุก ุงูุทูุจ (Backend)
```javascript
// ุงูุทูุจ ูููุดุฃ ุจุญุงูุฉ pending
Order.create({
  ...orderData,
  paymentStatus: 'pending',
  orderStatus: 'pending'
})

// ุงููุฎุฒูู ูุง ููุฎุตู (ููุท ูู COD ููุฎุตู ูุจุงุดุฑุฉ)
if (paymentMethod === 'cod') {
  product.stock -= quantity;
}
```

### 3๏ธโฃ ุฅูุดุงุก Tap Charge
```javascript
// ุฅูุดุงุก charge ูู Tap
const charge = await tapService.createCharge({
  amount: order.total,
  orderId: order._id,
  customerInfo: {...}
})

// ุญูุธ ูุนูููุงุช ุงูุทูุจ ูู localStorage
localStorage.setItem('pendingOrderId', orderId);
localStorage.setItem('pendingCart', JSON.stringify(items));

// ุงูุณูุฉ ูุง ุชููุณุญ ุจุนุฏ!
// ุงูุชูุฌูู ูุตูุญุฉ Tap
window.location.href = charge.paymentUrl;
```

### 4๏ธโฃ ุงูุนููู ูุฏูุน ูู Tap
```
- ูุฏุฎู ุจูุงูุงุช ุงูุจุทุงูุฉ
- Tap ุชุนุงูุฌ ุงูุฏูุน
- ุฅุฐุง ูุฌุญ: ูุฑุฌุน ูู /order-success?tap_id=xxx&orderId=xxx
- ุฅุฐุง ูุดู: ูุฑุฌุน ูู /order-success?tap_id=xxx&orderId=xxx
```

### 5๏ธโฃ ุงูุชุญูู ูู ุงูุฏูุน (Frontend)
```javascript
// ูู OrderSuccess.jsx
const verifyTapPayment = async (tapId, orderId) => {
  // ุงูุชุญูู ูู Backend
  const response = await api.get(`/payments/tap/verify/${tapId}`);
  
  if (response.data.paid) {
    // โ ุงูุฏูุน ูุฌุญ
    clearCart(); // ุงูุขู ููุณุญ ุงูุณูุฉ
    localStorage.removeItem('pendingOrderId');
    localStorage.removeItem('pendingCart');
    setPaymentStatus('success');
  } else {
    // โ ุงูุฏูุน ูุดู
    setPaymentStatus('failed');
  }
}
```

### 6๏ธโฃ Webhook ูู Tap (Backend)
```javascript
// Tap ุชุฑุณู webhook ุนูุฏ ูุฌุงุญ ุงูุฏูุน
POST /api/payments/tap/webhook

// ุชุญุฏูุซ ุงูุทูุจ
Order.findByIdAndUpdate(orderId, {
  paymentStatus: 'paid',
  orderStatus: 'confirmed',
  paidAt: new Date()
})

// ุฎุตู ุงููุฎุฒูู ุงูุขู
for (const item of order.items) {
  Product.findByIdAndUpdate(item.product, {
    $inc: { stock: -item.quantity, sales: item.quantity }
  })
}
```

### 7๏ธโฃ ุนุฑุถ ุงููุชูุฌุฉ ููุนููู

#### โ ุฅุฐุง ูุฌุญ ุงูุฏูุน:
```
- ุตูุญุฉ ูุฌุงุญ ูุน ุชูุงุตูู ุงูุทูุจ
- ุงูุณูุฉ ููุณูุญุฉ
- ุงูุทูุจ ูุธูุฑ ููุฅุฏุงุฑุฉ
- ุงููุฎุฒูู ูุฎุตูู
```

#### โ ุฅุฐุง ูุดู ุงูุฏูุน:
```
- ุตูุญุฉ ูุดู ูุน ุฑุณุงูุฉ ูุงุถุญุฉ
- ุฒุฑ "ุงุณุชุฑุฌุงุน ุงูุณูุฉ ูุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู"
- ุงูุณูุฉ ุชุฑุฌุน ูู localStorage
- ุงูุทูุจ ูุจูู pending (ูุฎูู ุนู ุงูุฅุฏุงุฑุฉ)
- ุงููุฎุฒูู ูู ููุฎุตู
```

---

## ๐ ุญุงูุงุช ุงูุทูุจ:

### ููุนููู:
```
pending + pending payment  โ ูู ูุฏูุน ุจุนุฏ (ูุฎูู)
paid + confirmed          โ ุชู ุงูุฏูุน (ูุธูุฑ)
paid + processing         โ ููุฏ ุงูุชุฌููุฒ
paid + shipped            โ ุชู ุงูุดุญู
paid + delivered          โ ุชู ุงูุชุณููู
```

### ููุฅุฏุงุฑุฉ:
```
- ุงูุทูุจุงุช pending payment ูุง ุชุธูุฑ
- ููุท ุงูุทูุจุงุช ุงููุฏููุนุฉ ุชุธูุฑ
- ูููู ููุชุฑุฉ ุญุณุจ ุงูุญุงูุฉ
```

---

## ๐ ุงูุฃูุงู:

### 1. ุงููุฎุฒูู ูุญูู
```javascript
// ูุง ููุฎุตู ุฅูุง ุจุนุฏ ุงูุฏูุน ุงููุนูู
if (paymentMethod === 'cod') {
  // COD: ุฎุตู ูุจุงุดุฑ
} else {
  // Online: ุฎุตู ุจุนุฏ webhook
}
```

### 2. ุงูุทูุจุงุช ูุญููุฉ
```javascript
// ุงูุทูุจุงุช pending ูุง ุชุธูุฑ ููุฅุฏุงุฑุฉ
query.$or = [
  { paymentStatus: { $ne: 'pending' } },
  { paymentMethod: 'cod' }
]
```

### 3. ุงูุณูุฉ ูุญููุฉ
```javascript
// ุชูุญูุธ ูู localStorage ุญุชู ูุฌุงุญ ุงูุฏูุน
localStorage.setItem('pendingCart', JSON.stringify(items));

// ุชูุณุชุฑุฌุน ุนูุฏ ุงููุดู
const restoreCart = () => {
  const items = JSON.parse(localStorage.getItem('pendingCart'));
  items.forEach(item => addItem(item));
}
```

---

## ๐งช ููุงุฎุชุจุงุฑ:

### ุณููุงุฑูู 1: ุฏูุน ูุงุฌุญ
```
1. ุฃุถู ููุชุฌ ููุณูุฉ
2. ุงุฐูุจ ููุฏูุน
3. ุงุฎุชุฑ Tap Payment
4. ุงุณุชุฎุฏู ุจุทุงูุฉ ุงุฎุชุจุงุฑ ูุงุฌุญุฉ: 4508750000000001
5. ุฃููู ุงูุฏูุน
6. โ ูุฌุจ ุฃู ุชุฑู ุตูุญุฉ ุงููุฌุงุญ
7. โ ุงูุณูุฉ ูุงุฑุบุฉ
8. โ ุงูุทูุจ ูุธูุฑ ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ
```

### ุณููุงุฑูู 2: ุฏูุน ูุงุดู
```
1. ุฃุถู ููุชุฌ ููุณูุฉ
2. ุงุฐูุจ ููุฏูุน
3. ุงุฎุชุฑ Tap Payment
4. ุงุณุชุฎุฏู ุจุทุงูุฉ ุงุฎุชุจุงุฑ ูุงุดูุฉ: 4000000000000002
5. ุฃู ุงุถุบุท "ุฅูุบุงุก" ูู ุตูุญุฉ Tap
6. โ ูุฌุจ ุฃู ุชุฑู ุตูุญุฉ ุงููุดู
7. โ ุงุถุบุท "ุงุณุชุฑุฌุงุน ุงูุณูุฉ"
8. โ ุงูุณูุฉ ุชุฑุฌุน ุจูู ุงูููุชุฌุงุช
9. โ ุงูุทูุจ ูุง ูุธูุฑ ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ
```

---

## โ ุงููุธุงู ุฌุงูุฒ!

ุงูุขู ูุธุงู Tap Payment ูุนูู ุจุดูู ุงุญุชุฑุงูู ูุขูู:
- โ ูุง ุฎุณุงุฑุฉ ููููุชุฌุงุช
- โ ูุง ุฎุตู ูููุฎุฒูู ูุจู ุงูุฏูุน
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ููุชุงุฒุฉ
- โ ุญูุงูุฉ ูุงููุฉ ููุจูุงูุงุช
