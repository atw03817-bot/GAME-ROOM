# نظام تعديل وحذف طلبات الصيانة للإدارة

## المميزات المضافة:

### 1. تمييز مصدر الطلب
✅ **تم الإضافة**: حقل `createdBy` في قاعدة البيانات
- `customer`: طلب من العميل (لا يمكن تعديله أو حذفه)
- `admin`: طلب من الإدارة (يمكن تعديله وحذفه)

### 2. دوال Backend جديدة
✅ **تم الإضافة**: دوال متخصصة للإدارة:
- `createMaintenanceRequestAdmin`: إنشاء طلب من الإدارة
- `updateMaintenanceRequestAdmin`: تعديل طلب (للطلبات المنشأة من الإدارة فقط)
- `deleteMaintenanceRequest`: حذف طلب (محدث للتحقق من المصدر)

### 3. Routes جديدة
✅ **تم الإضافة**: مسارات API جديدة:
- `POST /maintenance/admin/request`: إنشاء طلب من الإدارة
- `PUT /maintenance/admin/:id`: تعديل طلب (للإدارة فقط)
- `DELETE /maintenance/:id`: حذف طلب (محدث بالحماية)

### 4. صفحة تعديل الطلب
✅ **تم الإنشاء**: `EditMaintenanceRequest.jsx`
- نموذج تعديل كامل لجميع بيانات الطلب
- التحقق من صلاحية التعديل (طلبات الإدارة فقط)
- حفظ التغييرات مع تحديث التاريخ

### 5. أزرار التحكم في صفحة التفاصيل
✅ **تم الإضافة**: أزرار تعديل وحذف في `MaintenanceDetails.jsx`
- تظهر فقط للطلبات المنشأة من الإدارة
- زر "تعديل الطلب" (أخضر)
- زر "حذف الطلب" (أحمر) مع تأكيد
- رسائل خطأ واضحة عند المحاولة على طلبات العملاء

### 6. مؤشرات بصرية
✅ **تم الإضافة**: شارة "إدارة" في قائمة الطلبات
- تظهر بجانب رقم الطلب للطلبات المنشأة من الإدارة
- لون أزرق مميز لسهولة التعرف
- تظهر في العرض العادي والمحمول

## الحماية والأمان:

### 1. حماية Backend
- التحقق من `createdBy` قبل السماح بالتعديل/الحذف
- رسائل خطأ واضحة (403 Forbidden) للمحاولات غير المصرح بها
- تسجيل العمليات في تاريخ الطلب

### 2. حماية Frontend
- إخفاء أزرار التعديل/الحذف للطلبات غير المناسبة
- التحقق من الصلاحيات قبل عرض صفحة التعديل
- رسائل تأكيد للعمليات الحساسة (الحذف)

## سير العمل:

### إنشاء طلب من الإدارة:
1. الإدارة تدخل على `/admin/maintenance/create`
2. تملأ النموذج وترسله
3. يُحفظ الطلب مع `createdBy: 'admin'`
4. يظهر في القائمة مع شارة "إدارة"

### تعديل طلب:
1. الإدارة تفتح تفاصيل طلب منشأ من الإدارة
2. تضغط على "تعديل الطلب"
3. تعدل البيانات في النموذج
4. تحفظ التغييرات
5. يُسجل التعديل في تاريخ الطلب

### حذف طلب:
1. الإدارة تفتح تفاصيل طلب منشأ من الإدارة
2. تضغط على "حذف الطلب"
3. تؤكد الحذف في النافذة المنبثقة
4. يُحذف الطلب نهائياً

### محاولة تعديل/حذف طلب عميل:
1. الإدارة تفتح تفاصيل طلب منشأ من عميل
2. لا تظهر أزرار التعديل/الحذف
3. إذا حاولت الوصول مباشرة للرابط، تظهر رسالة خطأ

## الملفات المحدثة:

### Backend:
- `backend/models/MaintenanceRequest.js` - إضافة حقل `createdBy`
- `backend/controllers/maintenanceController.js` - دوال جديدة ومحدثة
- `backend/routes/maintenance.js` - مسارات جديدة

### Frontend:
- `frontend/src/pages/admin/CreateMaintenanceRequest.jsx` - تحديث endpoint
- `frontend/src/pages/admin/MaintenanceDetails.jsx` - أزرار تعديل/حذف
- `frontend/src/pages/admin/MaintenanceManagement.jsx` - شارة "إدارة"
- `frontend/src/pages/admin/EditMaintenanceRequest.jsx` - صفحة تعديل جديدة
- `frontend/src/App.jsx` - route جديد للتعديل

## الاختبار:
شغل `TEST_ADMIN_EDIT_DELETE.bat` لاختبار النظام الجديد

النظام الآن يدعم تعديل وحذف الطلبات بأمان مع حماية كاملة لطلبات العملاء!