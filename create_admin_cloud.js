// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©
const { MongoClient } = require('mongodb');
const bcrypt = require('bcryptjs');

// Ø±Ø§Ø¨Ø· Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©
const MONGODB_URI = 'mongodb+srv://atw03817:jP9AouAfbaifknI4@mobile-store-cluster.cylotee.mongodb.net/mobile-store?retryWrites=true&w=majority&appName=mobile-store-cluster';

// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±
const adminData = {
  phone: '0500909030',
  password: '123456'
};

async function createAdminInCloud() {
  console.log('ðŸš€ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©');
  console.log('================================================');
  console.log(`ðŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„: ${adminData.phone}`);
  console.log(`ðŸ” ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: ${adminData.password}`);
  console.log('â˜ï¸ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: MongoDB Atlas (Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©)');
  console.log('');

  let client;

  try {
    console.log('ðŸ”— Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©...');
    client = new MongoClient(MONGODB_URI);
    await client.connect();
    console.log('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­ Ù…Ø¹ MongoDB Atlas');

    const db = client.db('mobile-store');
    const users = db.collection('users');

    // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†
    const userCount = await users.countDocuments();
    console.log(`ðŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†: ${userCount}`);

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯
    console.log('ðŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯...');
    const existingUser = await users.findOne({ phone: adminData.phone });

    if (existingUser) {
      console.log('âš ï¸ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„');
      console.log(`   - Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ: ${existingUser.role}`);
      console.log(`   - Ù†Ø´Ø·: ${existingUser.isActive ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}`);
      console.log(`   - ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${existingUser.createdAt}`);
      
      if (existingUser.role !== 'ADMIN') {
        console.log('ðŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ± Ø¥Ù„Ù‰ Ù…Ø¯ÙŠØ±...');
        const updateResult = await users.updateOne(
          { phone: adminData.phone },
          { 
            $set: { 
              role: 'ADMIN', 
              updatedAt: new Date(),
              isActive: true 
            } 
          }
        );
        
        if (updateResult.modifiedCount > 0) {
          console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù…Ø¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­');
        } else {
          console.log('âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø£ÙŠ Ø´ÙŠØ¡');
        }
      } else {
        console.log('âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¯ÙŠØ± Ø¨Ø§Ù„ÙØ¹Ù„');
      }
    } else {
      // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
      console.log('ðŸ‘¤ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯...');
      console.log('ðŸ” ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±...');
      
      const hashedPassword = await bcrypt.hash(adminData.password, 10);
      console.log('âœ… ØªÙ… ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
      
      const newAdmin = {
        phone: adminData.phone,
        password: hashedPassword,
        role: 'ADMIN',
        isActive: true,
        phoneVerified: true,
        createdAt: new Date(),
        updatedAt: new Date(),
        lastLogin: null,
        email: null,
        name: null,
        addresses: []
      };

      console.log('ðŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©...');
      const result = await users.insertOne(newAdmin);
      
      if (result.acknowledged) {
        console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©!');
        console.log(`ðŸ†” Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${result.insertedId}`);
      } else {
        console.log('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¯ÙŠØ±');
      }
    }

    // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù†Ù‡Ø§Ø¦ÙŠØ©
    const finalUserCount = await users.countDocuments();
    const adminCount = await users.countDocuments({ role: 'ADMIN' });
    
    console.log('');
    console.log('ðŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©:');
    console.log(`   ðŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${finalUserCount}`);
    console.log(`   ðŸ‘‘ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ†: ${adminCount}`);
    console.log('');
    console.log('ðŸŽ‰ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…ÙƒØªÙ…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!');
    console.log('==========================');
    console.log('');
    console.log('ðŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:');
    console.log(`ðŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„: ${adminData.phone}`);
    console.log(`ðŸ” ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: ${adminData.password}`);
    console.log('');
    console.log('ðŸ”— Ø±ÙˆØ§Ø¨Ø· Ù…Ù‡Ù…Ø©:');
    console.log('   ðŸŒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: https://www.ab-tw.com/login');
    console.log('   âš™ï¸  Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: https://www.ab-tw.com/admin');
    console.log('   ðŸ  Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: https://www.ab-tw.com');
    console.log('');
    console.log('âš ï¸ ØªØ°ÙƒØ± ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„!');

  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:', error.message);
    console.log('');
    
    if (error.message.includes('authentication')) {
      console.log('ðŸ’¡ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:');
      console.log('   - ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Ø±Ø§Ø¨Ø· Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      console.log('   - ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒØªØ§Ø¨Ø©');
    } else if (error.message.includes('network') || error.message.includes('ENOTFOUND')) {
      console.log('ðŸ’¡ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø´Ø¨ÙƒØ©:');
      console.log('   - ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
      console.log('   - ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† MongoDB Atlas Ù…ØªØ§Ø­');
    } else if (error.message.includes('timeout')) {
      console.log('ðŸ’¡ Ù…Ø´ÙƒÙ„Ø© Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª:');
      console.log('   - Ø§Ù„Ø´Ø¨ÙƒØ© Ø¨Ø·ÙŠØ¦Ø©ØŒ Ø¬Ø±Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
    }
    
  } finally {
    if (client) {
      try {
        await client.close();
        console.log('ðŸ”Œ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©');
      } catch (closeError) {
        console.error('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„:', closeError.message);
      }
    }
  }
}

// Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
console.log('â˜ï¸ Ø³ÙƒØ±ÙŠØ¨Øª Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙŠ MongoDB Atlas');
console.log('ðŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®:', new Date().toLocaleString('ar-SA'));
console.log('ðŸ’» Node.js:', process.version);
console.log('ðŸ“ Ø§Ù„Ù…Ø¬Ù„Ø¯:', process.cwd());
console.log('');

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø©
createAdminInCloud().catch((error) => {
  console.error('ðŸ’¥ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:', error);
  process.exit(1);
});